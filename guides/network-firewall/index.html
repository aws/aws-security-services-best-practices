
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="AWS">
      
      
        <link rel="canonical" href="https://aws.github.io/aws-security-services-best-practices/guides/network-firewall/">
      
      
        <link rel="prev" href="../waf/using-waf-with-other-services/docs/">
      
      
        <link rel="next" href="../dns-firewall/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>AWS Network Firewall Best Practices - AWS Security Services Best Practices</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    

<script>
  (function(n,i,v,r,s,c,x,z){x=window.AwsRumClient={q:[],n:n,i:i,v:v,r:r,c:c};window[n]=function(c,p){x.q.push({c:c,p:p});};z=document.createElement('script');z.async=true;z.src=s;document.head.insertBefore(z,document.head.getElementsByTagName('script')[0]);})(
    'cwr',
    'de3746ff-7a70-4809-9b1e-3a49496628c6',
    '1.0.0',
    'us-east-1',
    'https://client.rum.us-east-1.amazonaws.com/1.15.0/cwr.js',
    {
      sessionSampleRate: 1,
      guestRoleArn: "arn:aws:iam::655298983051:role/RUM-Monitor-us-east-1-655298983051-6113407803071-Unauth",
      identityPoolId: "us-east-1:1d4fcb9f-2a3b-478f-b13a-a7019ac15d61",
      endpoint: "https://dataplane.rum.us-east-1.amazonaws.com",
      telemetries: ["performance","errors","http"],
      allowCookies: false,
      enableXRay: false
    }
  );
</script>


  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#aws-network-firewall" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AWS Security Services Best Practices" class="md-header__button md-logo" aria-label="AWS Security Services Best Practices" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWS Security Services Best Practices
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              AWS Network Firewall Best Practices
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-security-services-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-security-services-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Security Services Best Practices" class="md-nav__button md-logo" aria-label="AWS Security Services Best Practices" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    AWS Security Services Best Practices
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-security-services-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-security-services-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../certificate-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Certificate Services Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../detective/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Detective Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../guardduty/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon GuardDuty Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../inspector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Inspector Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../macie/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Macie Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security-hub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Security Hub Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security-lake/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Security Lake Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    AWS WAF Best Practices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            AWS WAF Best Practices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../waf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../waf/prerequisites/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WAF Prerequisites
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../waf/configuring-waf-rules/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuring WAF Rules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../waf/monitoring-waf-rules/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring WAF Rules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../waf/using-waf-with-other-services/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using WAF with other AWS Services
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    AWS Network Firewall Best Practices
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    AWS Network Firewall Best Practices
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-use-this-guide" class="md-nav__link">
    <span class="md-ellipsis">
      How to use this guide
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-aws-network-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      What is AWS Network Firewall?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-the-benefits-of-enabling-aws-network-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      What are the benefits of enabling AWS Network Firewall?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operationalizing" class="md-nav__link">
    <span class="md-ellipsis">
      Operationalizing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operationalizing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ensure-symmetric-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Ensure Symmetric Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-strict-rule-ordering-and-application-drop-established-and-application-alert-established-default-firewall-policy-actions" class="md-nav__link">
    <span class="md-ellipsis">
      Use Strict rule ordering and 'Application drop established' and 'Application alert established' default firewall policy actions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-stateful-rules-over-stateless-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Use Stateful rules over Stateless rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-custom-suricata-rules-instead-of-ui-generated-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Use Custom Suricata rules instead of UI generated rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-as-few-custom-rule-groups-as-possible" class="md-nav__link">
    <span class="md-ellipsis">
      Use as few Custom Rule Groups as possible
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-the-home_net-variable-is-set-correctly" class="md-nav__link">
    <span class="md-ellipsis">
      Ensure the $HOME_NET variable is set correctly
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-alert-rule-before-pass-rule-to-log-allowed-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      Use Alert rule before Pass rule to log allowed traffic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-flowto_server-keyword-in-stateful-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Use “flow:to_server” keyword in stateful rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use “flow:to_server” keyword in stateful rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-of-bad-ruleset-strict-rule-ordering-do-not-use" class="md-nav__link">
    <span class="md-ellipsis">
      Example of bad ruleset (Strict rule ordering) – DO NOT USE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-good-ruleset-strict-rule-ordering-ok-to-use" class="md-nav__link">
    <span class="md-ellipsis">
      Example of good ruleset (Strict rule ordering) – Ok to use
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-make-sure-your-new-stateful-firewall-rules-apply-to-existing-flows" class="md-nav__link">
    <span class="md-ellipsis">
      How to make sure your new Stateful firewall rules apply to existing flows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-logging-and-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Set up logging and monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Cost considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting-stateless-rules-for-asymmetric-forwarding" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting stateless rules for asymmetric forwarding
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-for-mitigating-client-side-tls-sni-manipulation-with-aws-network-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Options for Mitigating client side TLS SNI manipulation with AWS Network Firewall
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#workshops" class="md-nav__link">
    <span class="md-ellipsis">
      Workshops
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#videos" class="md-nav__link">
    <span class="md-ellipsis">
      Videos
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blogs" class="md-nav__link">
    <span class="md-ellipsis">
      Blogs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-code" class="md-nav__link">
    <span class="md-ellipsis">
      Sample Code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dns-firewall/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Route 53 Resolver DNS Firewall Best Practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributors
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-use-this-guide" class="md-nav__link">
    <span class="md-ellipsis">
      How to use this guide
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-aws-network-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      What is AWS Network Firewall?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-the-benefits-of-enabling-aws-network-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      What are the benefits of enabling AWS Network Firewall?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Considerations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operationalizing" class="md-nav__link">
    <span class="md-ellipsis">
      Operationalizing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operationalizing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ensure-symmetric-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Ensure Symmetric Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-strict-rule-ordering-and-application-drop-established-and-application-alert-established-default-firewall-policy-actions" class="md-nav__link">
    <span class="md-ellipsis">
      Use Strict rule ordering and 'Application drop established' and 'Application alert established' default firewall policy actions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-stateful-rules-over-stateless-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Use Stateful rules over Stateless rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-custom-suricata-rules-instead-of-ui-generated-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Use Custom Suricata rules instead of UI generated rules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-as-few-custom-rule-groups-as-possible" class="md-nav__link">
    <span class="md-ellipsis">
      Use as few Custom Rule Groups as possible
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ensure-the-home_net-variable-is-set-correctly" class="md-nav__link">
    <span class="md-ellipsis">
      Ensure the $HOME_NET variable is set correctly
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-alert-rule-before-pass-rule-to-log-allowed-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      Use Alert rule before Pass rule to log allowed traffic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-flowto_server-keyword-in-stateful-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Use “flow:to_server” keyword in stateful rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use “flow:to_server” keyword in stateful rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-of-bad-ruleset-strict-rule-ordering-do-not-use" class="md-nav__link">
    <span class="md-ellipsis">
      Example of bad ruleset (Strict rule ordering) – DO NOT USE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-good-ruleset-strict-rule-ordering-ok-to-use" class="md-nav__link">
    <span class="md-ellipsis">
      Example of good ruleset (Strict rule ordering) – Ok to use
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-make-sure-your-new-stateful-firewall-rules-apply-to-existing-flows" class="md-nav__link">
    <span class="md-ellipsis">
      How to make sure your new Stateful firewall rules apply to existing flows
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-logging-and-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Set up logging and monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Cost considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting-stateless-rules-for-asymmetric-forwarding" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting stateless rules for asymmetric forwarding
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-for-mitigating-client-side-tls-sni-manipulation-with-aws-network-firewall" class="md-nav__link">
    <span class="md-ellipsis">
      Options for Mitigating client side TLS SNI manipulation with AWS Network Firewall
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#workshops" class="md-nav__link">
    <span class="md-ellipsis">
      Workshops
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#videos" class="md-nav__link">
    <span class="md-ellipsis">
      Videos
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blogs" class="md-nav__link">
    <span class="md-ellipsis">
      Blogs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-code" class="md-nav__link">
    <span class="md-ellipsis">
      Sample Code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="aws-network-firewall">AWS Network Firewall</h1>
<h2 id="introduction">Introduction</h2>
<p>Welcome to the AWS Network Firewall Best Practices Guide. The purpose of this guide is to provide prescriptive guidance for AWS Network Firewall for efficiently protecting your VPCs and their workloads. Publishing this guidance via GitHub will allow for quick iterations to enable timely recommendations that include service enhancements, as well as the feedback of the user community. This guide is designed to provide value whether you are deploying Network Firewall for the first time in a single account, or looking for ways to optimize Network Firewall in an existing multi-account and/or multi-VPC deployment.</p>
<h2 id="how-to-use-this-guide">How to use this guide</h2>
<p>This guide is geared towards security practitioners who are responsible for monitoring and remediation of security events, malicious activity and vulnerabilities within AWS accounts (and resources). The best practices are organized into different categories for easier consumption. Each category includes a set of corresponding best practices that begin with a brief overview, followed by detailed steps for implementing the guidance. The topics do not need to be read in a particular order.</p>
<ul>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#deployment-considerations">Deployment Considerations</a></li>
<li><a href="#implementation">Implementation</a></li>
<li><a href="#operationalizing">Operationalizing</a></li>
<li><a href="#ensure-symmetric-routing">Ensure Symmetric Routing</a></li>
<li><a href="#use-strict-rule-ordering-and-application-drop-established-and-application-alert-established-default-firewall-policy-actions">Use Strict rule ordering and 'Application drop established' and 'Application alert established' default firewall policy actions</a></li>
<li><a href="#use-stateful-rules-over-stateless-rules">Use Stateful rules over Stateless rules</a></li>
<li><a href="#use-custom-suricata-rules-instead-of-ui-generated-rules">Use Custom Suricata rules instead of UI generated rules</a></li>
<li><a href="#use-as-few-custom-rule-groups-as-possible">Use as few Custom Rule Groups as possible</a></li>
<li><a href="#ensure-the-home_net-variable-is-set-correctly">Ensure the $HOME_NET variable is set correctly</a></li>
<li><a href="#use-alert-rule-before-pass-rule-to-log-allowed-traffic">Use Alert rule before Pass rule to log allowed traffic</a></li>
<li><a href="#use-flowto_server-keyword-in-stateful-rules">Use “flow:to_server” keyword in stateful rules</a></li>
<li><a href="#how-to-make-sure-your-new-stateful-firewall-rules-apply-to-existing-flows">How to make sure your new Stateful firewall rules apply to existing flows</a></li>
<li><a href="#set-up-logging-and-monitoring">Set up logging and monitoring</a></li>
<li><a href="#options-for-mitigating-client-side-tls-sni-manipulation-with-aws-network-firewall">Options for Mitigating client side TLS SNI manipulation with AWS Network Firewall</a></li>
<li><a href="#cost-considerations">Cost Considerations</a></li>
<li><a href="#troubleshooting-stateless-rules-for-asymmetric-forwarding">Troubleshooting stateless rules for asymmetric forwarding</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
<h2 id="what-is-aws-network-firewall">What is AWS Network Firewall?</h2>
<p>AWS Network Firewall is a managed service that makes it easy to deploy essential L3-L7 deep packet inspection protections for all of your <a href="https://aws.amazon.com/vpc/">Amazon Virtual Private Clouds (VPCs)</a>. It can filter traffic at the subnet level of your VPC, including filtering traffic going to and coming from an internet gateway, NAT gateway, over VPN, or AWS Direct Connect.</p>
<h2 id="what-are-the-benefits-of-enabling-aws-network-firewall">What are the benefits of enabling AWS Network Firewall?</h2>
<p>AWS Network Firewall has a highly flexible rule engine so you can build custom firewall rules to protect your unique workloads. It supports thousands of rules, and the rules can be based on port, protocol, and FQDN/domain. AWS Network Firewall supports rules written in Suricata format, giving you the ability to create customized rules based on specific network traffic characteristics, such as packet size or byte match pattern. Network Firewall also offers <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/stateful-rule-groups-domain-names.html">AWS Managed domain lists</a> and threat signatures so you don’t have to worry about writing and maintaining your own Suricata IPS rules.</p>
<h2 id="getting-started">Getting started</h2>
<p>In this section we will cover what you need to consider before activating AWS Network Firewall in your AWS infrastructure.</p>
<h3 id="deployment-considerations">Deployment Considerations</h3>
<p>When customers first start deploying AWS Network Firewall, they might be tempted to start configuring it right away without looking at all its capabilities, for example deploying endpoints to each VPC, only using managed rules or not using Alert rules. We recommend looking into the <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/what-is-aws-network-firewall.html">Network Firewall documentation</a> as this could be a significant time-saver later down the road.</p>
<p>To get started you should understand the three main architecture patterns for Network Firewall deployments and what would be best suite your environment.</p>
<ul>
<li>Distributed deployment model — Network Firewall is deployed into each individual VPC.</li>
<li>Centralized deployment model — Network Firewall is deployed into a centralized VPC attached to an instance of AWS Transit Gateway for East-West (VPC-to-VPC) or North-South (inbound and outbound from internet, on-premises) traffic. We refer to this VPC as the inspection VPC.</li>
<li>Combined deployment model — Network Firewall is deployed into a centralized inspection VPC for East-West (VPC-to-VPC) and a subset of North-South (on-premises, egress) traffic. Internet ingress is distributed to VPCs that require dedicated inbound access from the internet, and Network Firewall is deployed accordingly.</li>
</ul>
<p>See the <a href="https://aws.amazon.com/blogs/networking-and-content-delivery/deployment-models-for-aws-network-firewall/">Deployment models for AWS Network Firewall blog post</a> for further details about deployment models.</p>
<h2 id="implementation">Implementation</h2>
<p>In this section we will cover the minimum requirements for deploying AWS Network Firewall.</p>
<p>To deploy Network Firewall, you just need one VPC, one subnet, but for resiliency we highly recommend a firewall endpoint/subnet be deployed for each AZ that you have workloads in.</p>
<p><img alt="ANF VPC and Subnet Configuration settings" src="../../images/ANF-configure.png" /></p>
<p><em>Figure 1: Network Firewall VPC Configuration settings</em></p>
<p>If you want to encrypt the Network Firewall configuration data at rest with your own key, you will need to specify a KMS key.</p>
<p><img alt="ANF CMK configuration" src="../../images/ANF-cmk.png" /></p>
<p><em>Figure 2: Network Firewall CMK Configuration</em></p>
<p>For more information on deployment refer to the <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/what-is-aws-network-firewall.html">getting started with Network Firewall documentation</a></p>
<p>If you're implementing AWS Network Firewall into a production environment where you want the least amount of traffic disruption, we recommend you set the <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/stream-exception-policy.html">Stream exception policy option</a> to "Continue" or "Reject" and that you not have any default block actions. The Stream exception policy option of "Drop" can be more disruptive to production traffic since it silently blocks mid stream flows and does not send a TCP Reset.</p>
<h2 id="operationalizing">Operationalizing</h2>
<h3 id="ensure-symmetric-routing">Ensure Symmetric Routing</h3>
<p>Network Firewall does not support Asymmetric routing so you will need to ensure symmetric routing is configured in your VPC. When you deploy Network Firewall into a VPC, you need to modify the route tables to ensure traffic is sent through firewall endpoints so that it can be inspected. Network Firewall does not support asymmetric routing so the route tables have to account for network flows going to the firewall endpoint in both directions.</p>
<p>When using <a href="https://aws.amazon.com/transit-gateway/">AWS Transit Gateway (TGW)</a> in a centralized deployment configuration and using Network Firewall to inspect East-West traffic between VPCs, the <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/vpc-config.html">TGW’s appliance mode option</a> needs to be enabled for the attachments in the Inspection VPC. The appliance mode can be enabled in the AWS Console, as well as the API.</p>
<p>If appliance mode is not enabled, the return path traffic could land on an endpoint in a different AZ, which will prevent the Network Firewall from correctly evaluating the traffic against the firewall policy.</p>
<h3 id="use-strict-rule-ordering-and-application-drop-established-and-application-alert-established-default-firewall-policy-actions">Use Strict rule ordering and 'Application drop established' and 'Application alert established' default firewall policy actions</h3>
<ul>
<li>In Network Firewall there are two options for how the Suricata engine is going to process rules.</li>
<li>The “Strict” option is recommended because it instructs Suricata to process the rules in the order you have defined.</li>
<li>The “Action Order” option supports Suricata’s default rule processing which is appropriate for IDS use cases but is not a good fit for typical firewall use cases.</li>
<li>When selecting Strict rule-ordering you are also able to select a “Default” action, or actions that are run at the end of your rules and will be applied to any traffic not matching earlier rules.</li>
</ul>
<p><img alt="ANF Stateful Rule evaluation" src="../../images/nfw-default-actions.png" /></p>
<p><em>Figure 3: Network Firewall Stateful Rule evaluation</em></p>
<h3 id="use-stateful-rules-over-stateless-rules">Use Stateful rules over Stateless rules</h3>
<ul>
<li>Stateless rules should be used very sparingly because they can easily cause asymmetric flow forwarding issues (where only one side of the flow is seen by the stateful inspection engine of the firewall) and they tend to make the overall firewall ruleset more complex to understand and troubleshoot. For the large majority of use cases we recommend the stateless engine’s default action be set to “Forward to stateful rule groups” and we recommend not having any stateless rules configured since they take precedence over stateful rules.</li>
<li>If you are going to use stateless rules, it’s important to understand how to use the Network Firewall’s Stateless Rule Group Analyzer to troubleshoot and resolve asymmetric flow issues. See the “Troubleshooting stateless rules for asymmetric forwarding”</li>
<li>Customers should leverage Stateful rules if they want to get the deep packet inspection IPS capabilities of the Network Firewall. Some customers accidentally start with stateless rules only to find out later that they really needed to use stateful rules instead.</li>
<li>Stateless rules could be used in the case where you don't want some traffic to be logged or alerted on and simply denied, but for the most part your rule groups should look like this (below) in the AWS Console:</li>
</ul>
<p><img alt="ANF Stateless Rule Groups" src="../../images/ANF-stateless-rule-evaluation.png" /></p>
<p><em>Figure 4: Network Firewall Stateless Rule Groups</em></p>
<ul>
<li>Pros of using Stateful rules</li>
<li>Return traffic is automatically allowed so there is no need to define both ingress &amp; egress rules for the same flow of traffic</li>
<li>Deep packet inspection is supported, which gives you a deeper visibility into layer 7 attributes of the traffic</li>
<li>Supports logging so customers can review the full application level details of traffic, as well as the standard 5-tuple flow information</li>
<li>These rules are easier to troubleshoot, and they are much more flexible and capable than the stateless rules<ul>
<li>Customers can add a description to the rules, such as its creation date (with change request number), use case or other comments</li>
</ul>
</li>
<li>The Reject action is supported</li>
<li>The capacity calculation for these rules is easier to work with</li>
</ul>
<h3 id="use-custom-suricata-rules-instead-of-ui-generated-rules">Use Custom Suricata rules instead of UI generated rules</h3>
<p>These are configurable under the Stateful rule group options and are a free-form text that you to have full control. They allow you to more easily leverage the full flexibility of Suricata. Here are <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/suricata-examples.html">example Suricata rules</a> that customers have found helpful when getting started.</p>
<p><img alt="ANF Stateful Rule Group" src="../../images/ANF-stateful-rule-group.png" /></p>
<p><em>Figure 5: Network Firewall Stateful Rule Group</em></p>
<p>We recommend you educate yourself and your team on using custom Suricata rules early in their adoption because often later they will need the power and flexibility of custom Suricata rules to support all their use cases.  </p>
<p>The pros of using customer Suricata rules:</p>
<ul>
<li>Maximum flexibility</li>
<li>Control over the alerting and how it shows up in the logs</li>
<li>Custom rule signature ID can be used which helps troubleshooting and simplifying log analysis</li>
<li>Free-form text rules are easier to copy, edit, share, and backup.</li>
<li>Easy to switch rule(s) from one rule group to another (blue-green testing for example)</li>
<li>Allow for adding the very important keyword: “flow:to_server” to rules easily</li>
</ul>
<p>Below we have also included a custom template for an egress security use case to show examples of custom suricata rules.</p>
<pre><code># This is a &quot;Strict rule ordering&quot; egress security template meant only for the egress use case. These rules would need to be adjusted to accommodate any other use cases. Use this ruleset with &quot;Strict&quot; rule ordering firewall policy and no default block action, as this template includes custom default block rules at the end that block everything not explicently allowed.
# This template will not work well with the &quot;Drop All&quot; or &quot;Drop Established&quot; default firewall policy actions.
# Make sure the $HOME_NET variable is set correctly (do this at the firewall policy level so all Rule Groups inherit it)

# Silently allow TCP 3-way handshake to be setup by $HOME_NET clients
# Do not move this section, it's important that this be at the top of the entire firewall ruleset to reduce rule conflicts
pass tcp $HOME_NET any -&gt; any any (flow:not_established, to_server; sid:202501021;)
pass tcp any any -&gt; $HOME_NET any (flow:not_established, to_client; sid:202501022;)

# Silently turn on JA3/S hash logging for all other tls alert rules (like sid:999991)
alert tls $HOME_NET any -&gt; any any (ja3.hash; content:!&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;; noalert; flow:to_server; sid:202501024;)
alert tls any any -&gt; $HOME_NET any (ja3s.hash; content:!&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;; noalert; flow:to_client; sid:202501025;)

# Direct to IP connections
reject http $HOME_NET any -&gt; any any (http.host; content:&quot;.&quot;; pcre:&quot;/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/&quot;; msg:&quot;HTTP direct to IP via http host header (common malware download technique)&quot;; flow:to_server; sid:202501026;)
reject tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.&quot;; pcre:&quot;/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/&quot;; msg:&quot;TLS direct to IP via TLS SNI (common malware download technique)&quot;; flow:to_server; sid:202501027;)
# JA4 No SNI Reject
reject tls $HOME_NET any -&gt; any any (ja4.hash; content:&quot;_&quot;; startswith; content:!&quot;d&quot;; offset:3; depth:1; msg:&quot;JA4 No SNI Reject&quot;; sid:1297713;)

# Block higher risk Geoip
drop ip $HOME_NET any -&gt; any any (msg:&quot;Egress traffic to RU IP&quot;; geoip:dst,RU; metadata:geo RU; flow:to_server; sid:202501028;)
drop ip $HOME_NET any -&gt; any any (msg:&quot;Egress traffic to CN IP&quot;; geoip:dst,CN; metadata:geo CN; flow:to_server; sid:202501029;)

# Block higher risk ccTLDs
reject tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.ru&quot;; nocase; endswith; msg:&quot;Egress traffic to RU ccTLD&quot;; flow:to_server; sid:202501036;)
reject http $HOME_NET any -&gt; any any (http.host; content:&quot;.ru&quot;; endswith; msg:&quot;Egress traffic to RU ccTLD&quot;; flow:to_server; sid:202501037;)
reject tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.cn&quot;; nocase; endswith; msg:&quot;Egress traffic to CN ccTLD&quot;; flow:to_server; sid:202501038;)
reject http $HOME_NET any -&gt; any any (http.host; content:&quot;.cn&quot;; endswith; msg:&quot;Egress traffic to CN ccTLD&quot;; flow:to_server; sid:202501039;)

# Block QUICK traffic
drop quic $HOME_NET any -&gt; any any (msg:&quot;QUIC traffic blocked&quot;; flow:to_server; sid:3898932;)

# Log higher risk ports
alert ip $HOME_NET any -&gt; any 53 (msg:&quot;Possible GuardDuty/DNS Firewall bypass!&quot;; flow:to_server; sid:202501055;)
alert ip $HOME_NET any -&gt; any 1389 (msg:&quot;Possible Log4j callback!&quot;; flow:to_server; sid:202501059;)
alert ip $HOME_NET any -&gt; any [4444,666,3389] (msg:&quot;Egress traffic to high risk port!&quot;; flow:to_server; sid:202501058;)

# Port/protocol enforcement (TLS can only use TCP/443, TLS can't use anything other than TCP/443, etc.)
reject tcp $HOME_NET any -&gt; any 443 (msg:&quot;Egress Port TCP/443 but not TLS&quot;; app-layer-protocol:!tls; flow:to_server; sid:202501030;)
reject tls $HOME_NET any -&gt; any !443 (msg:&quot;Egress TLS but not port TCP/443&quot;; flow:to_server; sid:202501031;)
reject tcp $HOME_NET any -&gt; any 80 (msg:&quot;Egress Port TCP/80 but not HTTP&quot;; app-layer-protocol:!http; flow:to_server; sid:202501032;)
reject http $HOME_NET any -&gt; any !80 (msg:&quot;Egress HTTP but not port TCP/80&quot;; flow:to_server; sid:202501033;)
reject tcp $HOME_NET any -&gt; any 22 (msg:&quot;Egress Port TCP/22 but not SSH&quot;; app-layer-protocol:!ssh; flow:to_server; sid:202501060;)
reject ssh $HOME_NET any -&gt; any !22 (msg:&quot;Egress SSH but not port TCP/22&quot;; flow:to_server; sid:202501061;)

# Silently (do not log) allow low risk protocols out to anywhere
pass ntp $HOME_NET any -&gt; any 123 (flow:to_server; sid:202501034;)
pass icmp $HOME_NET any -&gt; any any (flow:to_server; sid:202501035;)

# Block high risk TLDs
reject tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.xyz&quot;; nocase; endswith; msg:&quot;High risk TLD .xyz blocked&quot;; flow:to_server; sid:202501040;)
reject http $HOME_NET any -&gt; any any (http.host; content:&quot;.xyz&quot;; endswith; msg:&quot;High risk TLD .xyz blocked&quot;; flow:to_server; sid:202501041;)
reject tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.info&quot;; nocase; endswith; msg:&quot;High risk TLD .info blocked&quot;; flow:to_server; sid:202501042;)
reject http $HOME_NET any -&gt; any any (http.host; content:&quot;.info&quot;; endswith; msg:&quot;High risk TLD .info blocked&quot;; flow:to_server; sid:202501043;)
reject tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.top&quot;; nocase; endswith; msg:&quot;High risk TLD .top blocked&quot;; flow:to_server; sid:202501044;)
reject http $HOME_NET any -&gt; any any (http.host; content:&quot;.top&quot;; endswith; msg:&quot;High risk TLD .top blocked&quot;; flow:to_server; sid:202501045;)

# Alert on requests to possible suspicious TLDs
alert tls $HOME_NET any -&gt; any any (tls.sni; pcre:&quot;/^(?!.*\.(com|org|net|io|edu|aws)$).*/i&quot;; msg:&quot;Request to possible suspicious TLDs&quot;; flow:to_server; sid:202501065;)
alert http $HOME_NET any -&gt; any any (http.host; pcre:&quot;/^(?!.*\.(com|org|net|io|edu|aws)$).*/i&quot;; msg:&quot;Request to possible suspicious TLDs&quot;; flow:to_server; sid:202501066;)


# Silently (do not log) allow AWS public service endpoints that we have not setup VPC endpoints for yet
# VPC endpoints are highly encouraged. They reduce NFW data processing costs and allow for additional security features like VPC endpoint policies.

pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ec2messages.&quot;; startswith; nocase; content:&quot;.amazonaws.com&quot;; endswith; nocase; flow:to_server; sid:202501047;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssm.&quot;; startswith; nocase; content:&quot;.amazonaws.com&quot;; endswith; nocase; flow:to_server; sid:202501048;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssmmessages.&quot;; startswith; nocase; content:&quot;.amazonaws.com&quot;; endswith; nocase; flow:to_server; sid:202501049;)

# Allow-list of strict FQDNs to silently allow
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;checkip.amazonaws.com&quot;; startswith; nocase; endswith; flow:to_server; sid:202501050;)
pass http $HOME_NET any -&gt; any any (http.host; content:&quot;checkip.amazonaws.com&quot;; startswith; endswith; flow:to_server; sid:202501051;)

# Allow-List of strict FQDNs, but still alert on them
# This method shows the verdict of &quot;pass&quot;
alert tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;www.example.com&quot;; startswith; nocase; endswith; msg:&quot;TLS SNI Allowed&quot;; flow:to_server; sid:202501052;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;www.example.com&quot;; startswith; nocase; endswith; flow:to_server; sid:202501053;)

# Allow HTTPS domain and also log it
# This method shows the verdict of &quot;alert&quot; instead of pass
pass tls $HOME_NET any -&gt; any any (alert; msg:&quot;www.example2.com allowed&quot;; tls.sni; content:&quot;www.example2.com&quot;; startswith; nocase; endswith; flow:to_server; sid:202506131;)


# Allow-List of second level/registered domain and all of its subdomains
# When using 'dotprefix': Always place it before 'content' and always include the leading dot in the domain name (.amazon.com in the following example)
pass tls $HOME_NET any -&gt; any any (tls.sni; dotprefix; content:&quot;.amazon.com&quot;; nocase; endswith; flow:to_server; sid:202501078;)

# Custom Block Rules
# These replace &quot;Drop All&quot; or &quot;Drop Established&quot; default actions

# Egress Default Block Rules
reject tls $HOME_NET any -&gt; any any (msg:&quot;Default Egress HTTPS Reject&quot;; ssl_state:client_hello; ja4.hash; content:&quot;_&quot;; flowbits:set,blocked; flow:to_server; sid:999991;)
alert tls $HOME_NET any -&gt; any any (msg:&quot;X25519Kyber768&quot;; flowbits:isnotset,blocked; flowbits:set,X25519Kyber768; noalert; flow:to_server; sid:999993;)
reject http $HOME_NET any -&gt; any any (msg:&quot;Default Egress HTTP Reject&quot;; flowbits:set,blocked; flow:to_server; sid:999992;)
reject tcp $HOME_NET any -&gt; any any (msg:&quot;Default Egress TCP Reject&quot;; flowbits:isnotset,blocked; flowbits:isnotset,X25519Kyber768; flow:to_server; sid:999994;)
drop udp $HOME_NET any -&gt; any any (msg:&quot;Default Egress UDP Drop&quot;; flow:to_server; sid:999995;)
drop icmp $HOME_NET any -&gt; any any (msg:&quot;Default Egress ICMP Drop&quot;; flow:to_server; sid:999996;)
drop ip $HOME_NET any -&gt; any any (msg:&quot;Default Egress All Other IP Drop&quot;; ip_proto:!TCP; ip_proto:!UDP; ip_proto:!ICMP; flow:to_server; sid:999997;)


# Ingress Default Block Rules in case ingress traffic lands on this firewall
# You may want to silence these rules by putting &quot;noalert&quot; on them to save on logging costs
drop tls any any -&gt; $HOME_NET any (msg:&quot;Default Ingress HTTPS Drop&quot;; ssl_state:client_hello; ja4.hash; content:&quot;_&quot;; flowbits:set,blocked; flow:to_server; sid:999999;)
alert tls any any -&gt; $HOME_NET any (msg:&quot;X25519Kyber768&quot;; flowbits:isnotset,blocked; flowbits:set,X25519Kyber768; noalert; flow:to_server; sid:9999910;)
drop http any any -&gt; $HOME_NET any (msg:&quot;Default Ingress HTTP Drop&quot;; flowbits:set,blocked; flow:to_server; sid:9999911;)
drop tcp any any -&gt; $HOME_NET any (msg:&quot;Default Ingress TCP Drop&quot;; flowbits:isnotset,blocked; flowbits:isnotset,X25519Kyber768; flow:to_server; sid:9999912;)
drop udp any any -&gt; $HOME_NET any (msg:&quot;Default Ingress UDP Drop&quot;; flow:to_server; sid:9999913;)
drop icmp any any -&gt; $HOME_NET any (msg:&quot;Default Ingress ICMP Drop&quot;; flow:to_server; sid:9999914;)
drop ip any any -&gt; $HOME_NET any (msg:&quot;Default Ingress All Other IP Drop&quot;; ip_proto:!TCP; ip_proto:!UDP; ip_proto:!ICMP; flow:to_server; sid:9999915;)
</code></pre>
<h3 id="use-as-few-custom-rule-groups-as-possible">Use as few Custom Rule Groups as possible</h3>
<p>The reasons for this we have listed below:</p>
<ul>
<li>When a custom rule group is created, its capacity needs to be defined and extra headroom needs to be taken into account because capacity cannot be modified after a rule group has been created. Having many rule groups creates additional headaches for managing rule capacity limits. For capacity it is recommended to set your custom rule group capcity to whatever leftover capacity you have after implementing your AWS managed rule groups.</li>
<li>With several rule groups to manage, understanding how traffic is going to be handled becomes more complex since every rule group needs to be inspected to analyze how it impacts the traffic. Seeing your rules in one view makes it easier to identify if a rule conflicts or overshadows other rules instead of jumping between multiple rule groups to stitch together an understanding of how traffic will be evaluated by the policy.</li>
<li>Network Firewall supports a maximum combined total of 20 rule groups (Managed and Custom).  If you create many custom rule groups you will limit how many AWS Managed Rule Groups can also be added.</li>
<li>For troubleshooting purposes, you will want to make sure Signature IDs (SIDs) are unique across all rule groups.  Within a single rule group Network Firewall will enforce unique SIDs, but not across all rule groups. If you don’t have unique SIDs across all rule groups then it can be more challenging to understand from the logs which rule actually handled the traffic.</li>
</ul>
<h3 id="ensure-the-home_net-variable-is-set-correctly">Ensure the $HOME_NET variable is set correctly</h3>
<p>By default the $HOME_NET variable is set to the CIDR range of the VPC where Network Firewall is deployed.</p>
<p><img alt="ANF HOME_NET variable" src="../../images/ANF-homenet-variable.png" /></p>
<p><em>Figure 6: Network Firewall HOME_NET Variable</em></p>
<p>However this default behavior might not cover the CIDR ranges of the VPCs you want to protect, like Spoke VPC A and Spoke VPC B in the above example.</p>
<p>You want to make sure that the $HOME_NET CIDR range lines up with all your VPCs that you intend to protect and match traffic against. Most customers benefit from setting $HOME_NET to all <a href="https://datatracker.ietf.org/doc/html/rfc1918">RFC 1918</a> IP address ranges (10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16).</p>
<p>This variable can be set at a global firewall policy level or in each rule group. If it’s set at both levels, the rule group setting wins.</p>
<p>The $HOME_NET variable and it’s inverse ($EXTERNAL_NET) are used for matching traffic in AWS managed rules. $EXTERNAL_NET follows $HOME_NET and is always anything outside of $HOME_NET.</p>
<p>When using the managed rules for an east/west use case you will want to decide which VPCs/CIDRs you want to protect and assign only those CIDRs to the $HOME_NET variable. If you assign all VPCs/CIDRs then none of those CIDR ranges will be matched by the $EXTERNAL_NET variable in the managed rules. You can also copy out the rules from the threat signatures and adjust the variables to your liking (even replacing the variables by “any“) if you want them to match any/all CIDRs. The downside of doing this is those rules will be static at that point in time and will not be automatically updated like the AWS managed rules.</p>
<p>Here is an example custom Suricata rule that can help you identify if you have traffic going through the firewall that is not included in $HOME_NET and perhaps should be:</p>
<p>alert tcp !$HOME_NET any -&gt; !$HOME_NET any (flow:to_server,established; msg:"It looks like you might have $HOME_NET traffic that is not a part of the $HOME_NET variable. Please make sure your $HOME_NET variable is set correctly."; sid:39179777;)</p>
<h3 id="use-alert-rule-before-pass-rule-to-log-allowed-traffic">Use Alert rule before Pass rule to log allowed traffic</h3>
<p>If you have a mandate to log all traffic (denied or allowed), you need to add an alert rule for the same traffic as the pass rule before the pass rule itself in your rule group because Pass rules in Suricata simply allow the traffic and do not log it.</p>
<pre><code>#Log allowed traffic to https://*.amazonaws.com
alert tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;.amazonaws.com&quot;; nocase; endswith; msg:&quot;*.amazonaws.com allowed by sid:021420242&quot;; flow:to_server; sid:021420241;)
pass tls $HOME_NET any-&gt; any any (tls.sni; content:&quot;.amazonaws.com&quot;; nocase; endswith; msg:&quot;Pass rules don't alert, alert is on sid:021420241&quot;; flow.to_server; sid:021420242;)
</code></pre>
<p>You need to use Strict Ordering and the Alert rule needs a higher priority than the Pass rule as demonstrated in the code sample above.</p>
<p>The SID in the alert rule message can refer the SID of the pass rule and vice-versa. It can be helpful to use longer SIDs so that you can quickly search your logs for that SID without the query showing unrealted information that might also contain that identifier.</p>
<p>Alternatively, you can add <code>alert;</code> keyword to pass rules, but they will produce a verdict in the alert log of alert instead of a verdict of pass. Example rule:</p>
<pre><code># This method shows the verdict of &quot;alert&quot; instead of pass
pass tls $HOME_NET any -&gt; any any (alert; msg:&quot;www.example2.com allowed&quot;; tls.sni; content:&quot;www.example2.com&quot;; startswith; nocase; endswith; flow:to_server; sid:202506131;)
</code></pre>
<h3 id="use-flowto_server-keyword-in-stateful-rules">Use “flow:to_server” keyword in stateful rules</h3>
<p>With Suricata, it’s possible to configure conflicting rule sets. When traffic to a destination operates at different layers of the <a href="https://en.wikipedia.org/wiki/OSI_model">OSI model</a>, traffic we want to allow that is operating at a higher level(for example TLS) might get blocked by a rule that is operating at a lower level. For example TCP:</p>
<h4 id="example-of-bad-ruleset-strict-rule-ordering-do-not-use">Example of bad ruleset (Strict rule ordering) – DO NOT USE</h4>
<pre><code># Rule 1 is intended to block http traffic to [baddomain.com](http://baddomain.com/)
reject http $HOME_NET any → any 80 (http.host; content:&quot;baddomain.com&quot;; sid:1;)

# Rule 2 allows the TCP port 80 traffic flow before application protocol inspection
pass tcp $HOME_NET any → any 80 (sid:2;)
</code></pre>
<p>Using “flow:to_server” in the rules will make them operate at the same level so the traffic can be evaluated at the same time, and the pass rule (sid:2) doesn’t allow the traffic in a way that takes precedence over the reject rule (sid:1) </p>
<h4 id="example-of-good-ruleset-strict-rule-ordering-ok-to-use">Example of good ruleset (Strict rule ordering) – Ok to use</h4>
<pre><code># Rule 1 will block http traffic to [baddomain.com](http://baddomain.com/)
reject http $HOME_NET any → any 80 (http.host; content:&quot;baddomain.com&quot;; sid:1;)

# Rule 2 will NOT take precedence over rule 1
pass tcp $HOME_NET any → any 80 (flow:to_server; sid:2;)
</code></pre>
<p>See <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/troubleshooting-rules.html">Troubleshooting rules in Network Firewall</a> for more information on troubleshooting firewall rules</p>
<h3 id="how-to-make-sure-your-new-stateful-firewall-rules-apply-to-existing-flows">How to make sure your new Stateful firewall rules apply to existing flows</h3>
<p>Network Firewall leverages the Suricata deep packet inspection engine for all Stateful firewall rules. After a flow has been allowed by a Suricata rule, Suricata places that flow in the state table so that it knows it no longer needs to spend resources running deep packet inspection on that flow. For as long as that flow remains active, any new Stateful firewall rules will not apply to that traffic since a decision was already made on that flow. Sometimes you may want your newly added Stateful firewall rules to apply to all traffic, including already active traffic that has been previously allowed through the firewall. For example, perhaps you began setting up the network firewall and started with an, "allow all traffic" type of rule, but then as you get further along in the deployment  and testing of network firewall you may want to narrow down your ruleset, and ensure that even already allowed traffic must be processed by your new rules.</p>
<p>How to clear the Network Firewall stateful rules state table</p>
<ul>
<li>Go into the "Details" page of your firewall policy</li>
<li>Edit the "Stream exception policy" to something other than what it is currently set to, and click Save</li>
<li>Then edit the "Stream exception policy" and set it back to what you had it set to before. In the majority of cases we recommend: "Stream exception policy: Reject"</li>
</ul>
<p>Now any and all traffic, even if it is traffic that was previously allowed, will be re-evaluated against the latest stateful firewall rules.</p>
<h3 id="set-up-logging-and-monitoring">Set up logging and monitoring</h3>
<p>Network Firewall supports two log types, Alert logs and Flow logs</p>
<p>Alert logs
  * Information from Suricata
  * IPS engine
  * Layer 7 attributes (like domains)
  * Protocol detection</p>
<p>Flow logs
  * 5=tuple information that flows across the firewall
  * Include the volume of traffic
  * Helps identify the top producers and consumers of data</p>
<p>The native <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/nwfw-using-dashboard.html">firewall monitoring dashboard</a> provides multiple options for viewing key metrics about your firewall. You can view all the metrics available as part of the dashboard <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/nwfw-detailed-monitoring-metrics.html">here</a>. </p>
<h2 id="cost-considerations">Cost considerations</h2>
<p>Because each Network Firewall endpoint has hourly charges even if it’s not used, reduce the number of endpoints by leveraging a centralized inspection design and Transit Gateway (TGW).</p>
<p>Do not send traffic to Network Firewall that does not need to be inspected. To avoid these unnecessary processing charges on Network Firewall, use TGW route tables to segment your network, for example keeping VPC Prod from talking to VPC Dev if these VPCs don’t need to communicate.</p>
<p>Use the <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/reporting.html">traffic analysis report feature</a> to see which domains are most likely driving up network processing charges.</p>
<p>Use the free VPC endpoints for S3 and DynamoDB instead of sending that traffic through Network Firewall.</p>
<p>Leverage PrivateLink endpoints provided by 3rd party services that do not need to be inspected by the firewall.</p>
<p>Ensure route tables are sending traffic to the local Network Firewall endpoint and not to another AZ’s endpoint. This design will avoid incurring cross-AZ data transfer charges.</p>
<p>Use DNS Firewall to keep traffic off of Network Firewall. Basic blocks can be configured at the DNS layer for traffic that would otherwise reach Network Firewall, effectively blocking traffic “closest to the packet source”.</p>
<p>You can add <code>"threshold: type limit, track by_both, seconds 600, count 1;"</code> to Suricata rules if you want to suppress their logging output to reduce logging costs. For example, the below rule will only alert one time every ten minutes per source and destination IP pair that triggers the rule.</p>
<p><code>alert ssh $HOME_NET any -&gt; any any (msg:"Egress SSH - alert only once every ten minutes"; threshold: type limit, track by_both, seconds 600, count 1; flow:to_server; sid:898233;)</code></p>
<h2 id="troubleshooting-stateless-rules-for-asymmetric-forwarding">Troubleshooting stateless rules for asymmetric forwarding</h2>
<p>Certain stateless rule configurations can cause traffic to be inspected by the stateful engine in one direction only, most commonly when a stateless “Pass” or “Forward to stateful rules” is used without a counterpart rule matching the return direction.</p>
<p>To identify stateless rules causing this asymmetric forwarding, use the service’s built-in rule analyzer, and then update your rule group to either remove the asymmetric rule or add a rule that matches the return traffic. You can use AWS Management Console to analyze your stateless rule group, or use the API or CLI by calling DescribeRuleGroup and setting the “AnalyzeRuleGroup” option.</p>
<p>Here’s an example of how you can analyze your rule group using AWS Management Console. Go to your stateless rule group and click “Analyze”</p>
<p><img alt="ANF Rule group analyzer" src="../../images/ANF-troubleshooting-1.png" /></p>
<p>The rule group analyzer identified that stateless rule with priority 2 will lead to asymmetric routing through Network Firewall.</p>
<p><img alt="ANF Analysis results" src="../../images/ANF-troubleshotting-2.png" /></p>
<p>To fix this issue you can click on “Edit” and add another rule to allow return traffic i.e. from 0.0.0.0/0 to 10.2.0.0/24.</p>
<p><img alt="ANF Analysis results edit" src="../../images/ANF-troubleshotting-3.png" /></p>
<p><img alt="ANF Fixed rule group" src="../../images/ANF-troubleshotting-4.png" /></p>
<p>After updating the rules, run the analyzer again to confirm the issue has been resolved.</p>
<p><img alt="ANF Anaylzer rerun" src="../../images/ANF-troubleshooting-5.png" /></p>
<p>Please reach out to AWS Support team if you have any questions.</p>
<h2 id="options-for-mitigating-client-side-tls-sni-manipulation-with-aws-network-firewall">Options for Mitigating client side TLS SNI manipulation with AWS Network Firewall</h2>
<p>TLS SNI filtering is the industry standard mechanism for network appliances to perform domain filtering to control egress traffic. It’s a straightforward and simple way to monitor and control TLS traffic without the need for resolving domains to IP addresses, which can be unreliable and also opens up a potential vulnerability since CDNs are so commonly used for website hosting, and allowing access to a CDN’s IP allows access to all domains hosted on the CDN, if the client is able to craft forged requests. SNI filtering also has a similar limitation, in that if a client is able to craft forged requests, the request could claim to be going to a legitimate domain, but actually connect to an illegitimate IP address instead. In both of these client side SNI manipulation cases a prerequisite is that the system is already to some extent compromised.</p>
<ul>
<li>So how do we address this?</li>
</ul>
<p>First and foremost, we concentrate on reducing the likelihood that the workload could be compromised to the extent that SNI manipulation could occur. Leveraging AWS Network Firewall’s Managed Rules, is a good place to start since they block well-known high risk threats. Many AWS customers start here, and then also move towards a least privilege security model where only a short list of legitimate domains is allowed, and all others are blocked by default. A domain allow-list reduces the risk surface substantially, again, further reducing the opportunity for a workload to be compromised and able to be used to send forged requests.</p>
<ul>
<li>But what if I want to directly block client side SNI manipulation with AWS Network Firewall?</li>
</ul>
<p>That can be accomplished by enabling <a href="https://docs.aws.amazon.com/network-firewall/latest/developerguide/tls-inspection-configurations.html">AWS Network Firewall’s TLS decryption feature</a>. When TLS decrypt is enabled, client side SNI manipulation is blocked by default and this error message is displayed in the firewall’s TLS log:</p>
<pre><code>{
    &quot;firewall_name&quot;: &quot;NetworkFirewall&quot;,
    &quot;availability_zone&quot;: &quot;us-east-1a&quot;,
    &quot;event_timestamp&quot;: 1727451885,
    &quot;event&quot;: {
        &quot;timestamp&quot;: &quot;2024-09-27T15:44:45.321222Z&quot;,
        &quot;src_ip&quot;: &quot;10.2.1.145&quot;,
        &quot;src_port&quot;: &quot;39038&quot;,
        &quot;dest_ip&quot;: &quot;44.193.128.70&quot;,
        &quot;dest_port&quot;: &quot;443&quot;,
        &quot;sni&quot;: &quot;spoofedsni.com&quot;,
        &quot;tls_error&quot;: {
            &quot;error_message&quot;: &quot;SNI: spoofedsni.com Match Failed to server certificate names: checkip.us-east-1.prod.check-ip.aws.a2z.com/checkip.us-east-1.prod.check-ip.aws.a2z.com/checkip.amazonaws.com/checkip.check-ip.aws.a2z.com &quot;
        }
    }
}
</code></pre>
<ul>
<li>But what other options do I have to block client side SNI manipulation?</li>
</ul>
<p>It’s possible to add both SNI Domain checks and DNS Domain-to-IP checks so that SNI requests are only allowed out to IP addresses that are associated with the domain in DNS. <a href="https://aws.amazon.com/blogs/security/how-to-control-non-http-and-non-https-traffic-to-a-dns-domain-with-aws-network-firewall-and-aws-lambda/">This is an example solution</a> that accomplishes this with Network Firewall. Both of these solutions above have downsides in added cost and/or complexity, so we recommend customers first start by moving towards a Domain Allow-List, and then determine if the workload’s security requirements dictate that more controls should be added.</p>
<p>Another capability Network Firewall has in combating TLS SNI spoofing is JA3 filtering. You can think of JA3 as similar to an HTTP User-Agent, but for TLS, and not easily configurable. You can learn more about JA3 <a href="https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967/">here</a>. Let's look at a couple examples of how we can use tls.sni filtering AND ja3.hash filtering together.</p>
<p>First let's assume my TLS domain allow-list looks like this:</p>
<pre><code>pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssm.us-east-1.amazonaws.com&quot;; nocase; flow:to_server; sid:11111;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssmmessages.us-east-1.amazonaws.com&quot;; nocase; flow:to_server; sid:22222;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ec2.us-east-1.amazonaws.com&quot;; nocase; flow:to_server; sid:33333;)
reject tls $HOME_NET any -&gt; any any (msg:&quot;TLS not on domain allow-list blocked&quot;; flow:to_server; sid:44444;)
</code></pre>
<p>If I wanted to lock it down further so that these specific domains can only be accessed by the JA3 hash of their client agents, I could convert my domain allow-list to look like this:</p>
<pre><code>pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssm.us-east-1.amazonaws.com&quot;; nocase; ja3.hash; content:&quot;7a15285d4efc355608b304698cd7f9ab&quot;; sid:11111;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssmmessages.us-east-1.amazonaws.com&quot;; nocase; ja3.hash; content:&quot;1be8360b66649edee1de25f81d98ec27&quot;; sid:22222;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ec2.us-east-1.amazonaws.com&quot;; nocase; ja3.hash; content:&quot;fd75aaca18604d62f2bc8b02b345140f&quot;; sid:33333;)
reject tls $HOME_NET any -&gt; any any (msg:&quot;TLS not on domain/JA3 allow-list blocked&quot;; flow:to_server; sid:44444;)
</code></pre>
<p>With the above ruleset in place, I can no longer curl to a domain on my domain allow-list, because each domain is locked down to only be accessible via the correct JA3. Now in order for SNI spoofing to be successful, not only would the client system need to be compromised to the extent that special commands could be crafted and launched from it, but now the attacker would have to have such deep control of the system that they could even manipulate the specific client agents/processes to make connections out to a domain on the allow-list.</p>
<p>Another option is to not be so strict, but instead allow only the 3 JA3s to access any of the SNIs like this:</p>
<pre><code>alert tls $HOME_NET any -&gt; any any (ja3.hash; content:&quot;7a15285d4efc355608b304698cd7f9ab&quot;; flowbits:set,ja3_allowed; noalert; sid:11111;)
alert tls $HOME_NET any -&gt; any any (ja3.hash; content:&quot;1be8360b66649edee1de25f81d98ec27&quot;; flowbits:set,ja3_allowed; noalert; sid:22222;)
alert tls $HOME_NET any -&gt; any any (ja3.hash; content:&quot;fd75aaca18604d62f2bc8b02b345140f&quot;; flowbits:set,ja3_allowed; noalert; sid:33333;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssm.us-east-1.amazonaws.com&quot;; nocase; flowbits:isset,ja3_allowed; sid:44444;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssmmessages.us-east-1.amazonaws.com&quot;; flowbits:isset,ja3_allowed; nocase; sid:55555;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ec2.us-east-1.amazonaws.com&quot;; nocase; flowbits:isset,ja3_allowed; sid:66666;)
reject tls $HOME_NET any -&gt; any any (msg:&quot;TLS not on domain/JA3 allow-list blocked&quot;; flow:to_server; sid:77777;)
</code></pre>
<p>The above two options have drawbacks in that they require that any time there is a client agent upgrade the new JA3 hash be added to the allow-list before it'll work. This is added complexity for added security value.</p>
<p>But how can we allow for a little bit of flexibility to ease the management of the allow-lists while still continuing to reduce the risk surface?</p>
<p>Another option is to track which destination IPs have been contacted by approved JA3 hashes, remember them for a period of time, and then only let our TLS domain allow list work out to those higher trust destination IPs. Here is what that ruleset might look like:</p>
<pre><code>alert tls $HOME_NET any -&gt; any any (ja3.hash; content:&quot;7a15285d4efc355608b304698cd7f9ab&quot;; xbits:set, allowed_ja3_destination_ips, track ip_dst, expire 21600; sid:11111;)
alert tls $HOME_NET any -&gt; any any (ja3.hash; content:&quot;1be8360b66649edee1de25f81d98ec27&quot;; xbits:set, allowed_ja3_destination_ips, track ip_dst, expire 21600; sid:22222;)
alert tls $HOME_NET any -&gt; any any (ja3.hash; content:&quot;fd75aaca18604d62f2bc8b02b345140f&quot;; xbits:set, allowed_ja3_destination_ips, track ip_dst, expire 21600; sid:33333;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssm.us-east-1.amazonaws.com&quot;; nocase; xbits:isset, allowed_ja3_destination_ips, track ip_dst; sid:44444;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ssmmessages.us-east-1.amazonaws.com&quot;; xbits:isset, allowed_ja3_destination_ips, track ip_dst; nocase; sid:55555;)
pass tls $HOME_NET any -&gt; any any (tls.sni; content:&quot;ec2.us-east-1.amazonaws.com&quot;; nocase; xbits:isset, allowed_ja3_destination_ips, track ip_dst; sid:66666;)
reject tls $HOME_NET any -&gt; any any (msg:&quot;TLS not on domain/A3 allow-list blocked&quot;; flow:to_server; sid:77777;)
</code></pre>
<p>The above option will let a new JA3 seen access the TLS domain allow list, but only if the request is going to an IP that an approved JA3 has already been talking to. This can provide some flexibility without providing too much flexibility.
Each customer will have to determine if their specific application's threat model justifies the added overhead of maintaining a JA3 allow-list. Most AWS Network Firewall customers are satisfied with the significant risk reduction of a domain allow-list, and don't find it necessary to also lock down the domains to an allow-list of JA3 hashes too.</p>
<h2 id="resources">Resources</h2>
<h3 id="workshops">Workshops</h3>
<ul>
<li><a href="https://catalog.workshops.aws/networkfirewall/en-US">AWS Network Firewall Workshop</a></li>
<li><a href="https://catalog.us-east-1.prod.workshops.aws/workshops/503778b9-6dbb-4e0d-9920-e8dbae141f43/en-US">Egress Controls Workshop</a></li>
</ul>
<h3 id="videos">Videos</h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=67pVOv3lPlk">Introduction, Best Practices and Custom Suricata Rules</a></li>
<li><a href="https://www.youtube.com/watch?v=BYVObzBWnqo&amp;list=PLhr1KZpdzukfJzNDd8eCJH_TGg24ZTwP6&amp;index=1&amp;pp=iAQB">AWS Network Firewall console experience</a></li>
<li><a href="https://www.youtube.com/watch?v=S7_hUxWrYmw&amp;list=PLhr1KZpdzukfJzNDd8eCJH_TGg24ZTwP6&amp;index=3&amp;pp=iAQB">Decrypt, inspect, and re-encrypt TLS egress traffic at scale</a></li>
<li><a href="https://www.youtube.com/watch?v=j2pLuHdAj0A&amp;list=PLhr1KZpdzukfJzNDd8eCJH_TGg24ZTwP6&amp;index=40&amp;pp=iAQB">Decrypt, inspect, and re-encrypt TLS traffic at scale</a></li>
<li><a href="https://www.youtube.com/watch?v=ufx8sO5s4BI&amp;list=PLhr1KZpdzukfJzNDd8eCJH_TGg24ZTwP6&amp;index=22&amp;pp=iAQB">AWS Network Fireall Suricata HOME_NET variable override</a></li>
<li><a href="https://www.youtube.com/watch?v=_K_2TVNygF4&amp;list=PLhr1KZpdzukfJzNDd8eCJH_TGg24ZTwP6&amp;index=54&amp;pp=iAQB">AWS Network Firewall support for reject action for TCP traffic</a></li>
<li><a href="https://www.youtube.com/watch?v=SDj_tMHN5Zk&amp;list=PLhr1KZpdzukfJzNDd8eCJH_TGg24ZTwP6&amp;index=55&amp;pp=iAQB">AWS Network Firewall tag-based resource groups</a></li>
<li><a href="https://www.youtube.com/watch?v=lTJxWAiQrHM">AWS re:Inforce 2023 - Firewalls, and where to put them (NIS306)</a></li>
</ul>
<h3 id="blogs">Blogs</h3>
<ul>
<li><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/deployment-models-for-aws-network-firewall/">Deployment models</a></li>
<li><a href="https://aws.amazon.com/blogs/security/cost-considerations-and-common-options-for-aws-network-firewall-log-management/">Cost considerations and common options for AWS Network Firewall log management</a></li>
<li><a href="https://aws.amazon.com/blogs/security/tls-inspection-configuration-for-encrypted-traffic-and-aws-network-firewall/">TLS inspection configuration for encrypted traffic and AWS Network Firewall</a></li>
<li><a href="https://aws.amazon.com/blogs/security/how-to-control-non-http-and-non-https-traffic-to-a-dns-domain-with-aws-network-firewall-and-aws-lambda/">How to control non-HTTP and non-HTTPS traffic to a DNS domain with AWS Network Firewall and AWS Lambda</a></li>
<li><a href="https://aws.amazon.com/blogs/security/use-aws-network-firewall-to-filter-outbound-https-traffic-from-applications-hosted-on-amazon-eks/">Use AWS Network Firewall to filter outbound HTTPS traffic from applications hosted on Amazon EKS and collect hostnames provided by SNI</a></li>
<li><a href="https://aws.amazon.com/blogs/security/how-to-deploy-aws-network-firewall-by-using-aws-firewall-manager/">How to deploy AWS Network Firewall by using AWS Firewall Manager</a></li>
<li><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/introducing-prefix-lists-in-aws-network-firewall-stateful-rule-groups/">Introducing Prefix Lists in AWS Network Firewall Stateful Rule Groups</a></li>
<li><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/how-to-analyze-aws-network-firewall-logs-using-amazon-opensearch-service-part-1/">How to analyze AWS Network Firewall logs using Amazon OpenSearch Service – Part 1</a></li>
<li><a href="https://aws.amazon.com/blogs/networking-and-content-delivery/how-to-analyze-aws-network-firewall-logs-using-amazon-opensearch-service-part-2/">How to analyze AWS Network Firewall logs using Amazon OpenSearch Service – Part 2</a></li>
</ul>
<h3 id="sample-code">Sample Code</h3>
<ul>
<li><a href="https://github.com/aws-samples/aws-networkfirewall-cfn-templates/tree/main/cloudwatch_dashboard">AWS Network Firewall CloudWatch Dashboard</a></li>
<li><a href="https://github.com/aws-samples/aws-network-firewall-automation-examples/tree/main">AWS Network Firewall Automation Examples</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Amazon 2023
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["tabs", "content.code.copy", "announce.dismiss", "header.autohide"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>